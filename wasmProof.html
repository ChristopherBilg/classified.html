//<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'></head><body><script>

let data = `
VGVzdCBkYXRh
`// data end

const encrypt = (data) => {
  // base-64, placeholder
  if (typeof window === "undefined"){
    return Buffer.from(data, 'utf8').toString('base64');
  } else {
    return window.btoa(data);
  }
}

const decrypt = (data) => {
  // base-64 reverted, placeholder
  if (typeof window === "undefined"){
    return Buffer.from(data, 'base64').toString('utf8');
  } else {
    return window.atob(data);
  }
}

const updateSourceData = (source, data) => {
  // remove the old data and insert new
  const sourceStart = source.split("let data" + " = `")[0] + "let data" + " = `\n";
  const sourceEnd = "\n`// data" + " end" + source.split("`// data" + " end")[1];
  return sourceStart + encrypt(data) + sourceEnd;
}

if (typeof window === "undefined") { // executed in Node.js
  const fs = require("fs");
  const path = require("path");
  const os = require("os");

  const filename = path.basename(__filename);
  const tmpPath = path.join(os.tmpdir(), filename);
  const newData = process.argv.slice(2).join(" ");

  // copy file to tmp file, and rename
  fs.readFile(__filename, "utf8", (err, source) => {
    if (err) throw err;
    const updatedSource = updateSourceData(source, decrypt(data) + newData);
    fs.writeFile(tmpPath, updatedSource, (err) => {
      if (err) throw err;
      fs.rename(tmpPath, __filename, (err) => {
        if (err) throw err;
        console.log("saved!");
      });
    });
  });
} else { // executed in Browser
  const htmlTop = "//<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'></head><body><script>";
  const htmlBottom = "<\/script></body></html>";
  const filename = location.href.split("/").slice(-1);
  const source = htmlTop + document.currentScript.innerHTML + htmlBottom;

  window.addEventListener("DOMContentLoaded", () => {
    document.body.childNodes[0].textContent = ""; // remove the first '//' required for cli excecution
    document.title = filename; // set document title based on the file name
  });

  // add text field with data
  let input = document.createElement("input");
  input.type = "text";
  input.value = decrypt(data);
  document.body.appendChild(input);

  // newline
  document.write ("<br>");

  // add button to load source
  const button = document.createElement("a");
  button.innerHTML = "Download source";
  const onClick = () => {
    button.href = URL.createObjectURL(
      new Blob(
        [updateSourceData(source, input.value)],
        { type: "data:text/plain" }
      )
    );
    button.download = filename;
  }
  button.onclick = onClick;
  document.body.appendChild(button);
}
//</script></body></html>