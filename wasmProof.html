//<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'></head><body><script>

let data = `
VGVzdCBkYXRh
`// data end

const encrypt = (data) => {
  // base-64, placeholder
  if (typeof window === "undefined"){
    return Buffer.from(data, 'utf8').toString('base64');
  } else {
    return window.btoa(data);
  }
}

const decrypt = (data, password) => {
  if (password !== "1234") {
    return [false, null]
  }

  // base-64 reverted, placeholder
  if (typeof window === "undefined"){
    return [true, Buffer.from(data, 'base64').toString('utf8')];
  } else {
    return [true, window.atob(data)];
  }
}

const updateSourceData = (source, data) => {
  // remove the old data and insert new
  const sourceStart = source.split("let data" + " = `")[0] + "let data" + " = `\n";
  const sourceEnd = "\n`// data" + " end" + source.split("`// data" + " end")[1];
  return sourceStart + encrypt(data) + sourceEnd;
}

if (typeof window === "undefined") { // executed in Node.js
  const fs = require("fs");
  const path = require("path");
  const os = require("os");

  const filename = path.basename(__filename);
  const tmpPath = path.join(os.tmpdir(), filename);
  const password = process.argv[2]
  const newData = process.argv.slice(3).join(" ");

  const [passwordCorrect, decryptedData] = decrypt(data, password);
  if (!passwordCorrect) {
    console.log("Incorrect password");
  } else {
    // copy file to tmp file, and rename
    fs.readFile(__filename, "utf8", (err, source) => {
      if (err) throw err;
      const updatedSource = updateSourceData(source, decryptedData + newData);
      fs.writeFile(tmpPath, updatedSource, (err) => {
        if (err) throw err;
        fs.rename(tmpPath, __filename, (err) => {
          if (err) throw err;
          console.log("saved!");
        });
      });
    });
  }
} else { // executed in Browser
  const htmlTop = "//<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'></head><body><script>";
  const htmlBottom = "<\/script></body></html>";
  const filename = location.href.split("/").slice(-1);
  const source = htmlTop + document.currentScript.innerHTML + htmlBottom;

  window.addEventListener("DOMContentLoaded", () => {
    document.body.childNodes[0].textContent = ""; // remove the first '//' required for cli excecution
    document.title = filename; // set document title based on the file name
  });

  // add text field for the password
  let passwordInput = document.createElement("input");
  passwordInput.type = "text";
  document.body.appendChild(passwordInput);

  // add button to load source
  const decryptButton = document.createElement("a");
  decryptButton.innerHTML = "Decrypt";
  const onClickDecrypt = (event) => {
    event.preventDefault();
    const [passwordCorrect, decryptedData] = decrypt(data, passwordInput.value);

    if (!passwordCorrect){
      alert("Incorrect password");
      return;
    }

    // add text field for the data
    let dataInput = document.createElement("input");
    dataInput.type = "text";
    dataInput.value = decryptedData;
    document.body.appendChild(dataInput);

    // add button to downlaod source
    const downloadButton = document.createElement("a");
    downloadButton.innerHTML = "Download source";
    const onClickDownload = (event) => {
      downloadButton.href = URL.createObjectURL(
        new Blob(
          [updateSourceData(source, dataInput.value)],
          { type: "data:text/plain" }
        )
      );
      downloadButton.download = filename;
    }
    downloadButton.onclick = onClickDownload;
    document.body.appendChild(downloadButton);
  }
  decryptButton.onclick = onClickDecrypt;
  document.body.appendChild(decryptButton);

  //newline
  document.write ("<br>");
}
//</script></body></html>